const mongoose = require("mongoose");
const bcrypt = require("bcryptjs");
require("dotenv").config();

// Import des mod√®les
const User = require("../models/User");
const Family = require("../models/Family");
const Student = require("../models/Student");
const Professor = require("../models/Professor");
const Assignment = require("../models/Assignment");

// Configuration de la base de donn√©es
const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log("MongoDB connect√© pour le seeding");
  } catch (error) {
    console.error("Erreur de connexion MongoDB:", error);
    process.exit(1);
  }
};

// Donn√©es de test
const seedData = async () => {
  try {
    console.log("üóëÔ∏è  Nettoyage de la base de donn√©es...");
    await User.deleteMany({});
    await Family.deleteMany({});
    await Student.deleteMany({});
    await Professor.deleteMany({});
    await Assignment.deleteMany({});

    console.log("üë• Cr√©ation des utilisateurs...");

    // Cr√©er un admin
    const adminPassword = await bcrypt.hash("admin123", 12);
    const admin = await User.create({
      email: "admin@abc-cours.fr",
      password: adminPassword,
      role: "admin",
      firstName: "Admin",
      lastName: "ABC Cours",
      phone: "0123456789",
    });

    // Cr√©er un professeur
    const profPassword = await bcrypt.hash("prof123", 12);
    const prof = await User.create({
      email: "prof@abc-cours.fr",
      password: profPassword,
      role: "professor",
      firstName: "Marie",
      lastName: "Dubois",
      phone: "0123456790",
    });

    console.log("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Cr√©ation des familles...");

    const family1 = await Family.create({
      name: "Famille Martin",
      address: {
        street: "123 Rue de la Paix",
        city: "Paris",
        postalCode: "75001",
      },
      contact: {
        primaryPhone: "0123456791",
        email: "martin@email.com",
      },
      parents: [
        {
          firstName: "Jean",
          lastName: "Martin",
          phone: "0123456791",
          email: "jean.martin@email.com",
          profession: "Ing√©nieur",
          isPrimaryContact: true,
        },
        {
          firstName: "Marie",
          lastName: "Martin",
          phone: "0123456792",
          email: "marie.martin@email.com",
          profession: "M√©decin",
        },
      ],
      notes: "Famille tr√®s impliqu√©e dans la scolarit√©",
    });

    const family2 = await Family.create({
      name: "Famille Bernard",
      address: {
        street: "456 Avenue des Champs",
        city: "Paris",
        postalCode: "75008",
      },
      contact: {
        primaryPhone: "0123456793",
        email: "bernard@email.com",
      },
      parents: [
        {
          firstName: "Sophie",
          lastName: "Bernard",
          phone: "0123456793",
          email: "sophie.bernard@email.com",
          profession: "Avocate",
          isPrimaryContact: true,
        },
        {
          firstName: "Pierre",
          lastName: "Bernard",
          phone: "0123456794",
          email: "pierre.bernard@email.com",
          profession: "Architecte",
        },
      ],
      notes: "Pr√©f√®re les cours en soir√©e",
    });

    console.log("üë®‚Äçüéì Cr√©ation des √©l√®ves...");

    const student1 = await Student.create({
      firstName: "Lucas",
      lastName: "Martin",
      dateOfBirth: new Date("2010-05-15"),
      family: family1._id,
      school: {
        name: "√âcole √âl√©mentaire Victor Hugo",
        level: "primaire",
        grade: "CM2",
      },
      subjects: [
        {
          name: "Math√©matiques",
          level: "interm√©diaire",
          notes: "Tr√®s motiv√©, progresse bien",
        },
        {
          name: "Fran√ßais",
          level: "interm√©diaire",
          notes: "Bonne compr√©hension",
        },
      ],
      notes: "Tr√®s motiv√©, progresse bien en maths",
      status: "active",
    });

    const student2 = await Student.create({
      firstName: "Emma",
      lastName: "Bernard",
      dateOfBirth: new Date("2009-08-22"),
      family: family2._id,
      school: {
        name: "Coll√®ge Jean Moulin",
        level: "coll√®ge",
        grade: "6√®me",
      },
      subjects: [
        {
          name: "Math√©matiques",
          level: "d√©butant",
          notes: "Besoin d'aide en alg√®bre",
        },
        {
          name: "Anglais",
          level: "avanc√©",
          notes: "Excellente compr√©hension",
        },
      ],
      notes: "Excellente en anglais, besoin d'aide en maths",
      status: "active",
    });

    console.log("üë®‚Äçüè´ Cr√©ation des professeurs...");

    const professor1 = await Professor.create({
      user: prof._id,
      subjects: [
        {
          name: "Math√©matiques",
          levels: ["primaire", "coll√®ge", "lyc√©e"],
          experience: 8,
        },
        {
          name: "Physique",
          levels: ["coll√®ge", "lyc√©e"],
          experience: 6,
        },
      ],
      availability: [
        {
          day: "monday",
          timeSlots: [
            { start: "14:00", end: "16:00" },
            { start: "18:00", end: "20:00" },
          ],
        },
        {
          day: "wednesday",
          timeSlots: [
            { start: "10:00", end: "12:00" },
            { start: "14:00", end: "18:00" },
          ],
        },
        {
          day: "saturday",
          timeSlots: [{ start: "09:00", end: "12:00" }],
        },
      ],
      hourlyRate: 35,
      status: "active",
      documents: [],
      education: [
        {
          degree: "Master en Math√©matiques",
          institution: "Universit√© Paris-Sorbonne",
          year: 2015,
          description: "Sp√©cialisation en alg√®bre et g√©om√©trie",
        },
      ],
      experience: [
        {
          position: "Professeur de math√©matiques",
          company: "Lyc√©e Victor Hugo",
          startDate: new Date("2016-09-01"),
          endDate: new Date("2023-06-30"),
          description: "Enseignement des math√©matiques niveau lyc√©e",
        },
      ],
      notes: "Professeur exp√©riment√©, tr√®s p√©dagogue",
    });

    const professor2 = await Professor.create({
      user: await User.create({
        email: "prof2@abc-cours.fr",
        password: await bcrypt.hash("prof123", 12),
        role: "professor",
        firstName: "Pierre",
        lastName: "Durand",
        phone: "0123456795",
      }),
      subjects: [
        {
          name: "Fran√ßais",
          levels: ["primaire", "coll√®ge", "lyc√©e"],
          experience: 5,
        },
        {
          name: "Histoire",
          levels: ["coll√®ge", "lyc√©e"],
          experience: 4,
        },
      ],
      availability: [
        {
          day: "tuesday",
          timeSlots: [
            { start: "16:00", end: "18:00" },
            { start: "19:00", end: "21:00" },
          ],
        },
        {
          day: "thursday",
          timeSlots: [
            { start: "14:00", end: "16:00" },
            { start: "17:00", end: "19:00" },
          ],
        },
        {
          day: "friday",
          timeSlots: [{ start: "16:00", end: "18:00" }],
        },
      ],
      hourlyRate: 30,
      status: "active",
      documents: [],
      education: [
        {
          degree: "Master en Lettres Modernes",
          institution: "Universit√© Paris-Diderot",
          year: 2018,
          description: "Sp√©cialisation en litt√©rature fran√ßaise",
        },
      ],
      experience: [
        {
          position: "Professeur de fran√ßais",
          company: "Coll√®ge Jean Moulin",
          startDate: new Date("2019-09-01"),
          endDate: new Date("2023-06-30"),
          description: "Enseignement du fran√ßais niveau coll√®ge",
        },
      ],
      notes: "Sp√©cialiste en litt√©rature fran√ßaise",
    });

    console.log("üìÖ Cr√©ation des assignations...");

    await Assignment.create({
      student: student1._id,
      professor: professor1._id,
      subject: "Math√©matiques",
      schedule: {
        day: "monday",
        startTime: "14:00",
        endTime: "15:00",
        duration: 60,
      },
      location: {
        type: "home",
        address: "123 Rue de la Paix, 75001 Paris",
      },
      status: "confirmed",
      payment: {
        amount: 35,
        method: "transfer",
        status: "pending",
        dueDate: new Date("2024-02-15"),
      },
      notes: {
        professor: "Cours de soutien en math√©matiques",
        student: "Tr√®s motiv√©",
        admin: "Assignation cr√©√©e automatiquement",
      },
    });

    await Assignment.create({
      student: student2._id,
      professor: professor2._id,
      subject: "Fran√ßais",
      schedule: {
        day: "tuesday",
        startTime: "16:00",
        endTime: "17:00",
        duration: 60,
      },
      location: {
        type: "home",
        address: "456 Avenue des Champs, 75008 Paris",
      },
      status: "confirmed",
      payment: {
        amount: 30,
        method: "transfer",
        status: "pending",
        dueDate: new Date("2024-02-20"),
      },
      notes: {
        professor: "Am√©lioration de la r√©daction",
        student: "Excellente en anglais",
        admin: "Assignation cr√©√©e automatiquement",
      },
    });

    console.log("Base de donn√©es peupl√©e avec succ√®s !");
    console.log("\nüìä R√©sum√© :");
    console.log(`- ${await User.countDocuments()} utilisateurs`);
    console.log(`- ${await Family.countDocuments()} familles`);
    console.log(`- ${await Student.countDocuments()} √©l√®ves`);
    console.log(`- ${await Professor.countDocuments()} professeurs`);
    console.log(`- ${await Assignment.countDocuments()} assignations`);

    console.log("\nüîë Comptes de test :");
    console.log("Admin: admin@abc-cours.fr / admin123");
    console.log("Professeur: prof@abc-cours.fr / prof123");

    process.exit(0);
  } catch (error) {
    console.error("Erreur lors du seeding:", error);
    process.exit(1);
  }
};

// Ex√©cution
connectDB().then(() => {
  seedData();
});
