const express = require("express");
const { NdrService } = require("../services/ndrService");
const Subject = require("../models/Subject");
const { authenticateToken, authorize } = require("../middleware/auth");
const {
  isValidObjectId,
  buildPaginationQuery,
  buildPaginatedResponse,
} = require("../utils/dbHelpers");

const router = express.Router();

// Toutes les routes nÃ©cessitent une authentification
router.use(authenticateToken);

// GET /api/ndrs - Liste des NDRs
router.get("/", async (req, res) => {
  try {
    const ndrs = await NdrService.getAllNDRs();
    res.json({ ndrs: ndrs });
  } catch (error) {
    console.error("Erreur dans GET /api/ndrs:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// GET /api/ndrs/:id - DÃ©tails d'une NDR
router.get("/:id", async (req, res) => {
  try {
    const { id } = req.params;

    if (!isValidObjectId(id)) {
      return res.status(400).json({ error: "Invalid NDR ID" });
    }

    const ndr = await NdrService.getNDRById(id);
    res.json(ndr);
  } catch (error) {
    console.error("Erreur dans GET /api/ndrs/:id:", error);
    if (error.message.includes("NDR non trouvÃ©e")) {
      return res.status(404).json({ error: "NDR not found" });
    }
    res.status(500).json({ error: "Internal server error" });
  }
});

// POST /api/ndrs - CrÃ©er une nouvelle NDR
router.post("/", authorize(["admin"]), async (req, res) => {
  try {
    const {
      familyId,
      beneficiaries,
      paymentMethod,
      paymentType,
      deadlines,
      subjects,
      hourlyRate,
      quantity,
      charges,
      status,
      notes,
      professor,
    } = req.body;

    // DonnÃ©es de la NDR selon le nouveau modÃ¨le
    const ndrData = {
      familyId,
      beneficiaries,
      paymentMethod,
      paymentType,
      deadlines,
      subjects,
      hourlyRate,
      quantity,
      charges,
      status,
      notes,
      professor,
      createdBy: {
        userId: req.user.id,
      },
    };

    // CrÃ©er la NDR avec gÃ©nÃ©ration automatique des coupons
    const newNDR = await NdrService.createNDR(ndrData);

    res.status(201).json({
      message: "NDR crÃ©Ã©e avec succÃ¨s",
      ndr: newNDR,
    });
  } catch (error) {
    console.error("Erreur dans POST /api/ndrs:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// PUT /api/ndrs/:id - Mettre Ã  jour une NDR
router.put("/:id", authorize(["admin"]), async (req, res) => {
  try {
    const { id } = req.params;

    if (!isValidObjectId(id)) {
      return res.status(400).json({ error: "Invalid settlement note ID" });
    }

    const {
      familyId,
      clientName,
      department,
      paymentMethod,
      subjectId,
      hourlyRate,
      quantity,
      professorSalary,
      charges,
      paymentSchedule,
      notes,
    } = req.body;

    // VÃ©rifier que la note existe
    const existingNote = await SettlementNote.findById(id);
    if (!existingNote) {
      return res.status(404).json({ error: "Settlement note not found" });
    }

    // VÃ©rifier que la matiÃ¨re existe
    if (subjectId) {
      const subjectExists = await Subject.findById(subjectId);
      if (!subjectExists) {
        return res.status(400).json({ error: "Subject not found" });
      }
    }

    // Mettre Ã  jour la note
    const updateData = {
      familyId,
      clientName,
      department,
      paymentMethod,
      subject: subjectId,
      hourlyRate,
      quantity,
      professorSalary,
      charges,
      notes,
    };

    // Ajouter l'Ã©chÃ©ancier si fourni
    if (paymentSchedule && paymentSchedule.paymentMethod) {
      updateData.paymentSchedule = {
        paymentMethod: paymentSchedule.paymentMethod,
        numberOfInstallments: paymentSchedule.numberOfInstallments,
        dayOfMonth: paymentSchedule.dayOfMonth,
        installments: paymentSchedule.installments || [],
      };
    }

    const updatedNote = await SettlementNote.findByIdAndUpdate(id, updateData, {
      new: true,
      runValidators: true,
    })
      .populate("subjects.id", "name category")
      .populate("createdBy", "firstName lastName")
      .populate("studentIds", "firstName lastName")
      .lean();

    res.json(updatedNote);
  } catch (error) {
    console.error("Update settlement note error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// DELETE /api/ndrs/:id - Supprimer une NDR
router.delete("/:id", authorize(["admin"]), async (req, res) => {
  try {
    const { id } = req.params;

    if (!isValidObjectId(id)) {
      return res.status(400).json({ error: "Invalid settlement note ID" });
    }

    const note = await SettlementNote.findById(id);
    if (!note) {
      return res.status(404).json({ error: "Settlement note not found" });
    }

    // Supprimer en cascade : coupons et sÃ©ries liÃ©s
    const CouponSeries = require("../models/CouponSeries");
    const Coupon = require("../models/Coupon");

    // Trouver la sÃ©rie de coupons liÃ©e
    const couponSeries = await CouponSeries.findOne({ settlementNoteId: id });
    if (couponSeries) {
      // Supprimer tous les coupons de la sÃ©rie
      await Coupon.deleteMany({ couponSeriesId: couponSeries._id });
      console.log(`Suppression des coupons de la sÃ©rie ${couponSeries._id}`);

      // Supprimer la sÃ©rie de coupons
      await CouponSeries.findByIdAndDelete(couponSeries._id);
      console.log(`Suppression de la sÃ©rie de coupons ${couponSeries._id}`);
    }

    // RELATION BIDIRECTIONNELLE : Retirer l'ID de la note de rÃ¨glement des Ã©lÃ¨ves AVANT suppression
    const Student = require("../models/Student");
    if (note.studentIds && note.studentIds.length > 0) {
      await Student.updateMany(
        { _id: { $in: note.studentIds } },
        { $pull: { settlementNoteIds: id } }
      );
      console.log(
        `âœ… Relation bidirectionnelle nettoyÃ©e pour ${note.studentIds.length} Ã©lÃ¨ves`
      );
    }

    // Supprimer la note de rÃ¨glement
    await SettlementNote.findByIdAndDelete(id);

    // Retirer l'ID de la note de rÃ¨glement de la famille
    const Family = require("../models/Family");
    await Family.findByIdAndUpdate(note.familyId, {
      $pull: { settlementNotes: id },
    });

    // VÃ©rifier si la famille n'a plus de notes de rÃ¨glement et changer le statut si nÃ©cessaire
    const family = await Family.findById(note.familyId);
    if (family && family.status === "client") {
      // Compter les NDR restantes pour cette famille
      const remainingNotes = await SettlementNote.countDocuments({
        familyId: note.familyId,
      });

      if (remainingNotes === 0) {
        // Plus aucune NDR, repasser en prospect
        await Family.findByIdAndUpdate(note.familyId, { status: "prospect" });
        console.log(
          `Statut de la famille ${family.primaryContact?.firstName} ${family.primaryContact?.lastName} changÃ© automatiquement de 'client' Ã  'prospect' (plus de NDR)`
        );
      }
    }

    res.json({
      message: "Settlement note deleted successfully",
      deletedCoupons: couponSeries ? "yes" : "no",
      deletedSeries: couponSeries ? "yes" : "no",
      statusChanged: family?.status === "client" ? "checked" : "no",
    });
  } catch (error) {
    console.error("Delete settlement note error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// PATCH /api/ndrs/:id - Mise Ã  jour partielle d'une NDR
router.patch("/:id", authorize(["admin"]), async (req, res) => {
  try {
    const { id } = req.params;

    if (!isValidObjectId(id)) {
      return res.status(400).json({ error: "Invalid settlement note ID" });
    }

    const note = await SettlementNote.findById(id);
    if (!note) {
      return res.status(404).json({ error: "Settlement note not found" });
    }

    console.log("ðŸ”„ PATCH settlement note - DonnÃ©es reÃ§ues:", req.body);

    // Extraire seulement les champs autorisÃ©s pour la mise Ã  jour partielle
    const allowedUpdates = {};
    const { clientName, department, status, paymentMethod, notes, subjects } =
      req.body;

    if (clientName !== undefined) allowedUpdates.clientName = clientName;
    if (department !== undefined) allowedUpdates.department = department;
    if (status !== undefined) allowedUpdates.status = status;
    if (paymentMethod !== undefined)
      allowedUpdates.paymentMethod = paymentMethod;
    if (notes !== undefined) allowedUpdates.notes = notes;
    if (subjects !== undefined) allowedUpdates.subjects = subjects;

    // Mettre Ã  jour la date de modification
    allowedUpdates.updatedAt = new Date();

    console.log("ðŸ”„ Champs Ã  mettre Ã  jour:", allowedUpdates);

    const updatedNote = await SettlementNote.findByIdAndUpdate(
      id,
      { $set: allowedUpdates },
      { new: true, runValidators: true }
    )
      .populate("subjects.id", "name category")
      .populate("createdBy", "firstName lastName")
      .populate("studentIds", "firstName lastName")
      .lean();

    console.log("âœ… Note mise Ã  jour avec succÃ¨s");
    res.json(updatedNote);
  } catch (error) {
    console.error("Update settlement note error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// PATCH /api/ndrs/:id/mark-paid - Marquer comme payÃ©
router.patch("/:id/mark-paid", authorize(["admin"]), async (req, res) => {
  try {
    const { id } = req.params;

    if (!isValidObjectId(id)) {
      return res.status(400).json({ error: "Invalid settlement note ID" });
    }

    const note = await SettlementNote.findById(id);
    if (!note) {
      return res.status(404).json({ error: "Settlement note not found" });
    }

    await note.markAsPaid();

    const updatedNote = await SettlementNote.findById(id)
      .populate("subjects.id", "name category")
      .populate("createdBy", "firstName lastName")
      .populate("studentIds", "firstName lastName")
      .lean();

    res.json(updatedNote);
  } catch (error) {
    console.error("Mark as paid error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// GET /api/ndrs - RÃ©cupÃ©rer toutes les NDRs
router.get("/", authorize(["admin"]), async (req, res) => {
  try {
    const {
      page = 1,
      limit = 10,
      status,
      clientName,
      department,
      familyId,
    } = req.query;

    // Construire le filtre
    const filter = {};
    if (status) filter.status = status;
    if (clientName) filter.clientName = { $regex: clientName, $options: "i" };
    if (department) filter.department = { $regex: department, $options: "i" };
    if (familyId) filter.familyId = familyId;

    // Pagination
    const skip = (parseInt(page) - 1) * parseInt(limit);

    const [notes, total] = await Promise.all([
      SettlementNote.find(filter)
        .populate("subjects.id", "name category")
        .populate("createdBy", "firstName lastName")
        .populate("studentIds", "firstName lastName")
        .sort({ createdAt: -1 })
        .skip(skip)
        .limit(parseInt(limit))
        .lean(),
      SettlementNote.countDocuments(filter),
    ]);

    res.json({
      notes,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        pages: Math.ceil(total / parseInt(limit)),
      },
    });
  } catch (error) {
    console.error("Get settlement notes error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// GET /api/ndrs/stats - Statistiques des NDRs
router.get("/stats", async (req, res) => {
  try {
    const [
      total,
      pending,
      paid,
      overdue,
      totalAmount,
      totalPaid,
      totalPending,
      totalOverdue,
    ] = await Promise.all([
      SettlementNote.countDocuments(),
      SettlementNote.countDocuments({ status: "pending" }),
      SettlementNote.countDocuments({ status: "paid" }),
      SettlementNote.countDocuments({ status: "overdue" }),
      SettlementNote.aggregate([
        {
          $group: {
            _id: null,
            total: { $sum: { $multiply: ["$hourlyRate", "$quantity"] } },
          },
        },
      ]),
      SettlementNote.aggregate([
        { $match: { status: "paid" } },
        {
          $group: {
            _id: null,
            total: { $sum: { $multiply: ["$hourlyRate", "$quantity"] } },
          },
        },
      ]),
      SettlementNote.aggregate([
        { $match: { status: "pending" } },
        {
          $group: {
            _id: null,
            total: { $sum: { $multiply: ["$hourlyRate", "$quantity"] } },
          },
        },
      ]),
      SettlementNote.aggregate([
        { $match: { status: "overdue" } },
        {
          $group: {
            _id: null,
            total: { $sum: { $multiply: ["$hourlyRate", "$quantity"] } },
          },
        },
      ]),
    ]);

    const stats = {
      total,
      pending,
      paid,
      overdue,
      totalAmount: totalAmount[0]?.total || 0,
      totalPaid: totalPaid[0]?.total || 0,
      totalPending: totalPending[0]?.total || 0,
      totalOverdue: totalOverdue[0]?.total || 0,
    };

    res.json(stats);
  } catch (error) {
    console.error("Get settlement stats error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// GET /api/ndrs/:id - RÃ©cupÃ©rer une NDR spÃ©cifique
router.get("/:id", authorize(["admin"]), async (req, res) => {
  try {
    const { id } = req.params;

    if (!isValidObjectId(id)) {
      return res.status(400).json({ error: "Invalid settlement note ID" });
    }

    const note = await SettlementNote.findById(id)
      .populate("subjects.id", "name category")
      .populate("createdBy", "firstName lastName")
      .populate("studentIds", "firstName lastName")
      .populate("couponSeriesId", "totalCoupons usedCoupons status")
      .lean();

    if (!note) {
      return res.status(404).json({ error: "Settlement note not found" });
    }

    res.json(note);
  } catch (error) {
    console.error("Get settlement note error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// GET /api/ndrs/:id/deletion-preview - AperÃ§u de suppression d'une NDR
router.get("/:id/deletion-preview", authorize(["admin"]), async (req, res) => {
  try {
    const { id } = req.params;

    if (!isValidObjectId(id)) {
      return res.status(400).json({ error: "Invalid settlement note ID" });
    }

    // RÃ©cupÃ©rer la note de rÃ¨glement
    const note = await SettlementNote.findById(id)
      .populate("subjects.id", "name category")
      .populate("createdBy", "firstName lastName")
      .populate("studentIds", "firstName lastName")
      .populate("familyId", "primaryContact")
      .lean();

    if (!note) {
      return res.status(404).json({ error: "Settlement note not found" });
    }

    // Trouver la sÃ©rie de coupons liÃ©e
    const CouponSeries = require("../models/CouponSeries");
    const Coupon = require("../models/Coupon");

    const couponSeries = await CouponSeries.findOne({
      settlementNoteId: id,
    }).lean();
    let couponsInfo = null;

    if (couponSeries) {
      // Compter les coupons utilisÃ©s et non utilisÃ©s
      const [usedCoupons, unusedCoupons] = await Promise.all([
        Coupon.countDocuments({
          couponSeriesId: couponSeries._id,
          status: "used",
        }),
        Coupon.countDocuments({
          couponSeriesId: couponSeries._id,
          status: "available",
        }),
      ]);

      couponsInfo = {
        seriesId: couponSeries._id,
        totalCoupons: couponSeries.totalCoupons,
        usedCoupons,
        unusedCoupons,
        status: couponSeries.status,
      };
    }

    // VÃ©rifier l'impact sur le statut de la famille
    const Family = require("../models/Family");
    let familyStatusChange = null;

    if (note.familyId) {
      const family = await Family.findById(note.familyId).lean();
      if (family && family.status === "client") {
        // Compter les autres NDR de cette famille
        const otherNotesCount = await SettlementNote.countDocuments({
          familyId: note.familyId,
          _id: { $ne: id },
        });

        if (otherNotesCount === 0) {
          familyStatusChange = {
            from: "client",
            to: "prospect",
            reason: "Plus aucune note de rÃ¨glement aprÃ¨s suppression",
          };
        }
      }
    }

    // Calculer le montant total (totalRevenue)
    const totalAmount = note.subjects.reduce(
      (sum, subject) =>
        sum + (subject.hourlyRate || 0) * (subject.quantity || 0),
      0
    );

    // PrÃ©parer les donnÃ©es de prÃ©visualisation dans le format attendu par le frontend
    const couponSeriesDetails = couponsInfo
      ? [
          {
            subject: note.subjects[0]?.subjectId?.name || "MatiÃ¨re inconnue",
            totalCoupons: couponsInfo.totalCoupons,
            usedCoupons: couponsInfo.usedCoupons,
            remainingCoupons: couponsInfo.unusedCoupons,
            hourlyRate: note.subjects[0]?.hourlyRate || 0,
            status: couponsInfo.status,
          },
        ]
      : [];

    const deletionPreview = {
      settlementNote: {
        clientName: note.clientName,
        department: note.department,
        totalAmount: totalAmount,
        status: note.status,
        createdAt: note.createdAt,
      },
      itemsToDelete: {
        couponSeries: {
          count: couponsInfo ? 1 : 0,
          details: couponSeriesDetails,
        },
        coupons: {
          count: couponsInfo
            ? couponsInfo.usedCoupons + couponsInfo.unusedCoupons
            : 0,
          availableCount: couponsInfo ? couponsInfo.unusedCoupons : 0,
          usedCount: couponsInfo ? couponsInfo.usedCoupons : 0,
        },
      },
      totalItems:
        (couponsInfo ? 1 : 0) +
        (couponsInfo ? couponsInfo.usedCoupons + couponsInfo.unusedCoupons : 0),
      // Garder l'ancien format pour compatibilitÃ© si nÃ©cessaire
      impacts: {
        coupons: couponsInfo,
        familyStatusChange,
        cascadeOperations: [
          ...(couponsInfo
            ? [
                "Suppression de tous les coupons de la sÃ©rie",
                "Suppression de la sÃ©rie de coupons",
              ]
            : []),
          "Retrait de la NDR de la famille",
          ...(familyStatusChange
            ? [
                `Changement statut famille: ${familyStatusChange.from} â†’ ${familyStatusChange.to}`,
              ]
            : []),
        ],
      },
    };

    res.json(deletionPreview);
  } catch (error) {
    console.error("Get deletion preview error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// GET /api/ndrs/:id/coupons - RÃ©cupÃ©rer les dÃ©tails des coupons d'une NDR
router.get("/:id/coupons", authorize(["admin"]), async (req, res) => {
  try {
    const { id } = req.params;

    if (!isValidObjectId(id)) {
      return res.status(400).json({ error: "Invalid settlement note ID" });
    }

    // RÃ©cupÃ©rer la sÃ©rie de coupons avec tous les dÃ©tails
    const couponSeries =
      await CouponGenerationService.getCouponSeriesBySettlementNote(id);

    res.json({
      settlementNoteId: id,
      couponSeries,
      stats: await CouponGenerationService.getCouponSeriesStats(
        couponSeries._id
      ),
    });
  } catch (error) {
    console.error("Erreur dans GET /api/settlement-notes/:id/coupons:", error);
    if (error.message.includes("Aucune sÃ©rie de coupons trouvÃ©e")) {
      return res.status(404).json({ error: error.message });
    }
    res.status(500).json({ error: "Internal server error" });
  }
});

// GET /api/coupons/search/:code - Rechercher un coupon par son code
router.get("/coupons/search/:code", async (req, res) => {
  try {
    const { code } = req.params;

    if (!code || code.trim() === "") {
      return res.status(400).json({ error: "Code de coupon requis" });
    }

    const coupon = await CouponGenerationService.findCouponByCode(
      code.trim().toUpperCase()
    );

    res.json({
      coupon,
      message: "Coupon trouvÃ© avec succÃ¨s",
    });
  } catch (error) {
    console.error("Erreur dans la recherche de coupon:", error);

    if (error.message.includes("Coupon non trouvÃ©")) {
      return res.status(404).json({ error: "Coupon non trouvÃ©" });
    }

    res.status(500).json({ error: "Erreur interne du serveur" });
  }
});

module.exports = router;
